name: ğŸš€ Deploy

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  # Allow manual deployment
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'preview'
        type: choice
        options:
          - preview
          - production

# Prevent concurrent deployments to the same environment
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}-${{ inputs.environment || 'auto' }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20'
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

jobs:
  # Job 1: Environment validation
  validate-environment:
    name: âœ… Validate Environment
    runs-on: ubuntu-latest
    outputs:
      deploy-type: ${{ steps.determine.outputs.deploy-type }}
      environment: ${{ steps.determine.outputs.environment }}
    steps:
      - name: ğŸ›ï¸ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ¯ Determine deployment type
        id: determine
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "deploy-type=manual" >> $GITHUB_OUTPUT
            echo "environment=${{ inputs.environment }}" >> $GITHUB_OUTPUT
            echo "ğŸ“ Manual deployment to ${{ inputs.environment }}"
          elif [ "${{ github.ref }}" = "refs/heads/main" ] && [ "${{ github.event_name }}" = "push" ]; then
            echo "deploy-type=production" >> $GITHUB_OUTPUT  
            echo "environment=production" >> $GITHUB_OUTPUT
            echo "ğŸš€ Production deployment (main branch push)"
          elif [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "deploy-type=preview" >> $GITHUB_OUTPUT
            echo "environment=preview" >> $GITHUB_OUTPUT
            echo "ğŸ‘ï¸ Preview deployment (pull request)"
          else
            echo "deploy-type=none" >> $GITHUB_OUTPUT
            echo "environment=none" >> $GITHUB_OUTPUT
            echo "â­ï¸ No deployment needed for this trigger"
          fi

      - name: ğŸ” Validate required secrets
        if: steps.determine.outputs.deploy-type != 'none'
        run: |
          echo "ğŸ” Validating deployment secrets..."
          
          missing_secrets=""
          
          if [ -z "$VERCEL_ORG_ID" ]; then
            missing_secrets="$missing_secrets VERCEL_ORG_ID"
          fi
          
          if [ -z "$VERCEL_PROJECT_ID" ]; then
            missing_secrets="$missing_secrets VERCEL_PROJECT_ID"
          fi
          
          if [ -z "${{ secrets.VERCEL_TOKEN }}" ]; then
            missing_secrets="$missing_secrets VERCEL_TOKEN"
          fi
          
          if [ ! -z "$missing_secrets" ]; then
            echo "âŒ Missing required secrets:$missing_secrets"
            echo "Please configure these secrets in your GitHub repository settings:"
            echo "- VERCEL_ORG_ID: Your Vercel organization ID"
            echo "- VERCEL_PROJECT_ID: Your Vercel project ID"  
            echo "- VERCEL_TOKEN: Your Vercel deployment token"
            exit 1
          else
            echo "âœ… All required secrets are configured"
          fi

  # Job 2: Pre-deployment build and tests
  pre-deploy-checks:
    name: ğŸ§ª Pre-deployment Checks
    runs-on: ubuntu-latest
    needs: validate-environment
    if: needs.validate-environment.outputs.deploy-type != 'none'
    steps:
      - name: ğŸ›ï¸ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¥ Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: ğŸ”§ Type check
        run: npm run type-check

      - name: ğŸ§¹ Lint
        run: npm run lint

      - name: ğŸ—ï¸ Build application
        run: npm run build
        env:
          NEXT_TELEMETRY_DISABLED: 1
          # Use environment-specific variables
          NODE_ENV: ${{ needs.validate-environment.outputs.environment == 'production' && 'production' || 'development' }}

      - name: ğŸ§ª Run tests
        run: npm run test

      - name: ğŸ“Š Build size analysis
        run: |
          echo "ğŸ“Š Build size analysis:"
          if [ -d ".next" ]; then
            du -sh .next/
            find .next/static -name "*.js" -exec du -h {} + | sort -hr | head -5 | sed 's/^/  /'
          fi

  # Job 3: Deploy to Vercel
  deploy-vercel:
    name: ğŸš€ Deploy to Vercel
    runs-on: ubuntu-latest
    needs: [validate-environment, pre-deploy-checks]
    if: needs.validate-environment.outputs.deploy-type != 'none'
    environment:
      name: ${{ needs.validate-environment.outputs.environment }}
      url: ${{ steps.deploy.outputs.url }}
    outputs:
      deployment-url: ${{ steps.deploy.outputs.url }}
      deployment-id: ${{ steps.deploy.outputs.deployment-id }}
    steps:
      - name: ğŸ›ï¸ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ“¥ Install Vercel CLI
        run: npm install --global vercel@canary

      - name: ğŸ”— Link Vercel project
        run: |
          echo "ğŸ”— Linking to Vercel project..."
          vercel link --yes --token=${{ secrets.VERCEL_TOKEN }}
        env:
          VERCEL_ORG_ID: ${{ env.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ env.VERCEL_PROJECT_ID }}

      - name: ğŸ“‹ Set environment variables
        run: |
          echo "ğŸ“‹ Configuring environment variables..."
          
          # Set common environment variables
          if [ "${{ needs.validate-environment.outputs.environment }}" = "production" ]; then
            echo "ğŸ”´ Production deployment"
            # Production-specific environment variables would go here
          else
            echo "ğŸŸ¡ Preview deployment"
            # Preview-specific environment variables would go here
          fi

      - name: ğŸ—ï¸ Build with Vercel
        id: build
        run: |
          echo "ğŸ—ï¸ Building with Vercel..."
          
          if [ "${{ needs.validate-environment.outputs.environment }}" = "production" ]; then
            vercel build --prod --token=${{ secrets.VERCEL_TOKEN }}
          else
            vercel build --token=${{ secrets.VERCEL_TOKEN }}
          fi
        env:
          VERCEL_ORG_ID: ${{ env.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ env.VERCEL_PROJECT_ID }}

      - name: ğŸš€ Deploy to Vercel
        id: deploy
        run: |
          echo "ğŸš€ Deploying to Vercel..."
          
          if [ "${{ needs.validate-environment.outputs.environment }}" = "production" ]; then
            deployment_url=$(vercel deploy --prod --prebuilt --token=${{ secrets.VERCEL_TOKEN }})
          else
            deployment_url=$(vercel deploy --prebuilt --token=${{ secrets.VERCEL_TOKEN }})
          fi
          
          echo "âœ… Deployed to: $deployment_url"
          echo "url=$deployment_url" >> $GITHUB_OUTPUT
          
          # Extract deployment ID from URL for later use
          deployment_id=$(echo "$deployment_url" | sed 's/.*\/\/\([^.]*\)\..*/\1/')
          echo "deployment-id=$deployment_id" >> $GITHUB_OUTPUT
        env:
          VERCEL_ORG_ID: ${{ env.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ env.VERCEL_PROJECT_ID }}

      - name: ğŸ“ Add deployment comment (PR only)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const deploymentUrl = '${{ steps.deploy.outputs.url }}';
            const comment = `## ğŸš€ Deployment Preview
            
            Your changes have been deployed to Vercel!
            
            **ğŸ”— Preview URL:** ${deploymentUrl}
            
            **ğŸ“Š Deployment Details:**
            - Environment: Preview
            - Commit: \`${{ github.sha }}\`
            - Branch: \`${{ github.head_ref }}\`
            
            ---
            *This comment will be automatically updated on new commits.*`;
            
            // Check if a deployment comment already exists
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const existingComment = comments.find(comment => 
              comment.body.includes('ğŸš€ Deployment Preview')
            );
            
            if (existingComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: comment
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }

  # Job 4: Post-deployment validation
  post-deploy-validation:
    name: âœ… Post-deployment Validation  
    runs-on: ubuntu-latest
    needs: [validate-environment, deploy-vercel]
    if: needs.validate-environment.outputs.deploy-type != 'none'
    steps:
      - name: ğŸ›ï¸ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ¥ Health check
        run: |
          echo "ğŸ¥ Performing health check on ${{ needs.deploy-vercel.outputs.deployment-url }}"
          
          deployment_url="${{ needs.deploy-vercel.outputs.deployment-url }}"
          
          # Wait a bit for deployment to be ready
          echo "â³ Waiting for deployment to be ready..."
          sleep 30
          
          # Basic health check
          max_attempts=10
          attempt=1
          
          while [ $attempt -le $max_attempts ]; do
            echo "ğŸ” Health check attempt $attempt/$max_attempts"
            
            response=$(curl -s -o /dev/null -w "%{http_code}" "$deployment_url" || echo "000")
            
            if [ "$response" = "200" ]; then
              echo "âœ… Health check passed - HTTP $response"
              break
            else
              echo "âš ï¸ Health check failed - HTTP $response"
              
              if [ $attempt -eq $max_attempts ]; then
                echo "âŒ Health check failed after $max_attempts attempts"
                exit 1
              fi
              
              echo "â³ Waiting 10 seconds before retry..."
              sleep 10
            fi
            
            attempt=$((attempt + 1))
          done

      - name: ğŸ§ª Basic smoke tests
        run: |
          echo "ğŸ§ª Running basic smoke tests..."
          
          deployment_url="${{ needs.deploy-vercel.outputs.deployment-url }}"
          
          # Test if the page contains expected content
          echo "ğŸ“„ Testing page content..."
          page_content=$(curl -s "$deployment_url" || echo "")
          
          if echo "$page_content" | grep -q "<html"; then
            echo "âœ… Valid HTML page detected"
          else
            echo "âŒ No valid HTML found in response"
            exit 1
          fi
          
          # Test if Next.js is working (look for Next.js markers)
          if echo "$page_content" | grep -q "__NEXT\|next/script\|_next/static"; then
            echo "âœ… Next.js application detected"
          else
            echo "âš ï¸ Next.js markers not found - may be static content"
          fi
          
          # Test if the page is mobile-friendly (basic check)
          if echo "$page_content" | grep -q "viewport"; then
            echo "âœ… Mobile-friendly viewport meta tag found"
          else
            echo "âš ï¸ No viewport meta tag found"
          fi

      - name: ğŸ” Performance check
        run: |
          echo "ğŸ” Basic performance check..."
          
          deployment_url="${{ needs.deploy-vercel.outputs.deployment-url }}"
          
          # Measure response time
          response_time=$(curl -o /dev/null -s -w "%{time_total}" "$deployment_url" || echo "0")
          
          echo "â±ï¸ Response time: ${response_time}s"
          
          # Convert to milliseconds for comparison
          response_ms=$(echo "$response_time * 1000" | bc -l | cut -d. -f1)
          
          if [ "$response_ms" -lt 3000 ]; then
            echo "âœ… Good response time (< 3s)"
          elif [ "$response_ms" -lt 5000 ]; then
            echo "âš ï¸ Acceptable response time (3-5s)"
          else
            echo "âŒ Slow response time (> 5s)"
          fi

  # Job 5: Deployment summary
  deployment-summary:
    name: ğŸ“‹ Deployment Summary
    runs-on: ubuntu-latest
    needs: [validate-environment, deploy-vercel, post-deploy-validation]
    if: always() && needs.validate-environment.outputs.deploy-type != 'none'
    steps:
      - name: ğŸ“‹ Generate deployment summary
        run: |
          echo "## ğŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.deploy-vercel.result }}" = "success" ]; then
            echo "âœ… **Deployment Status:** Success" >> $GITHUB_STEP_SUMMARY
            echo "ğŸ”— **URL:** ${{ needs.deploy-vercel.outputs.deployment-url }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Deployment Status:** Failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Environment Validation | ${{ needs.validate-environment.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Pre-deployment Checks | ${{ needs.pre-deploy-checks.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Vercel Deployment | ${{ needs.deploy-vercel.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Post-deployment Validation | ${{ needs.post-deploy-validation.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ğŸ“Š Deployment Details" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment:** ${{ needs.validate-environment.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Type:** ${{ needs.validate-environment.outputs.deploy-type }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "- **PR:** #${{ github.event.number }}" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ğŸ‰ Success notification
        if: needs.deploy-vercel.result == 'success' && needs.post-deploy-validation.result == 'success'
        run: |
          echo "ğŸ‰ Deployment completed successfully!"
          echo "ğŸ”— Your application is live at: ${{ needs.deploy-vercel.outputs.deployment-url }}"
          
          if [ "${{ needs.validate-environment.outputs.environment }}" = "production" ]; then
            echo "ğŸš€ Production deployment complete!"
          else
            echo "ğŸ‘ï¸ Preview deployment ready for testing!"
          fi

      - name: âŒ Failure notification
        if: failure()
        run: |
          echo "âŒ Deployment failed!"
          echo "Please check the logs above for details."
          echo ""
          echo "Common issues:"
          echo "- Missing environment variables"
          echo "- Build failures"
          echo "- Invalid Vercel configuration"
          echo "- Network connectivity issues"